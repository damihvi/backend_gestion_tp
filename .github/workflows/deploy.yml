name: Deploy Django to Azure VPS

on: 
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on:  ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets. VPS_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to VPS
      env:
        VPS_HOST: ${{ secrets. VPS_HOST }}
        VPS_USER: ${{ secrets. VPS_USERNAME }}
        PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        VENV_PATH: ${{ secrets. VENV_PATH }}
      run: |
        ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST "
          set -e
          
          echo 'üöÄ Iniciando despliegue...'
          echo '================================'
          
          echo '‚úÖ 1. Navegando al directorio del proyecto...'
          cd $PROJECT_PATH
          
          echo '‚úÖ 2. Actualizando c√≥digo desde GitHub...'
          git fetch origin
          git reset --hard origin/master
          git pull origin master
          
          echo '‚úÖ 3. Activando entorno virtual...'
          source $VENV_PATH/bin/activate
          
          echo '‚úÖ 4. Instalando/actualizando dependencias...'
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo '‚úÖ 5. Aplicando migraciones de base de datos...'
          python manage. py migrate --noinput
          
          echo '‚úÖ 6. Recolectando archivos est√°ticos...'
          python manage.py collectstatic --noinput --clear
          
          echo '‚úÖ 7. Verificando configuraci√≥n de Nginx...'
          nginx -t
          
          echo '‚úÖ 8. Reiniciando Gunicorn...'
          systemctl restart gunicorn
          systemctl status gunicorn --no-pager
          
          echo '‚úÖ 9. Reiniciando Nginx...'
          systemctl restart nginx
          systemctl status nginx --no-pager
          
          echo '================================'
          echo 'üéâ Despliegue completado exitosamente!'
          echo 'üåê Accede a:  http://herrera-transporte-api. desarrollo-software.xyz/admin/'
        "
